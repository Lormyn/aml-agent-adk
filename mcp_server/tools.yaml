sources:
  aml-analysis-data:
    kind: bigquery
    project: ${GOOGLE_CLOUD_PROJECT}
    location: US
    useClientOAuth: true

tools:
  # ----------------------------------------------------------------------
  # 1. ALERT CONTEXT - Start Here
  # ----------------------------------------------------------------------
  get-user-details:
    kind: bigquery-sql
    source: aml-analysis-data
    description: |
      Retrieves full KYC profile for a specific user. 
      Essential for SAR reporting (Address, Phone, Email, etc).
    parameters:
      - name: user_id
        type: string
        description: The User ID.
    statement: |
      SELECT 
        user_id,
        name,
        occupation,
        email,
        phone,
        address,
        annual_income,
        risk_score,
        joined_date,
        is_pep
      FROM 
        `aml_dataset.users`
      WHERE 
        user_id = @user_id

  search-user-by-name:
    kind: bigquery-sql
    source: aml-analysis-data
    description: |
      Search for a user by their name to find their User ID and profile.
      Useful when you only have a name (e.g. "Who is John Smith?").
    parameters:
      - name: name
        type: string
        description: The name (or partial name) to search for.
    statement: |
      SELECT 
        user_id,
        name,
        occupation,
        email,
        phone,
        address,
        annual_income,
        risk_score,
        joined_date,
        is_pep
      FROM 
        `aml_dataset.users`
      WHERE 
        LOWER(name) LIKE LOWER(CONCAT('%', @name, '%'))
      LIMIT 5

  get-alert-details:
    kind: bigquery-sql
    source: aml-analysis-data
    description: |
      Retrieves full context for an alert, joining Alert data with User profile.
      Returns the trigger reason, user risk score, and KYC details.
    parameters:
      - name: alert_id
        type: string
        description: The unique Alert UUID.
    statement: |
      SELECT 
        a.alert_id,
        a.trigger_reason,
        a.severity,
        a.created_at,
        u.user_id,
        u.name,
        u.occupation,
        u.risk_score,
        u.annual_income,
        u.is_pep
      FROM 
        `aml_dataset.alerts` a
      JOIN 
        `aml_dataset.users` u ON a.user_id = u.user_id
      WHERE 
        a.alert_id = @alert_id

  # ----------------------------------------------------------------------
  # 2. MONEY FLOW - Trace Funds
  # ----------------------------------------------------------------------
  trace-money-flow:
    kind: bigquery-sql
    source: aml-analysis-data
    description: |
      Traces money leaving a user's account. Shows who they sent money to, 
      and where that money went next (2 hops). Critical for finding mule rings.
    parameters:
      - name: user_id
        type: string
        description: The User ID to trace funds FROM.
    statement: |
      WITH hop1 AS (
        SELECT 
          sender_id, 
          receiver_id as hop1_receiver, 
          amount, 
          timestamp 
        FROM `aml_dataset.transactions` 
        WHERE sender_id = @user_id
      ),
      hop2 AS (
        SELECT 
          t.sender_id as hop1_receiver, 
          t.receiver_id as hop2_receiver, 
          t.amount, 
          t.timestamp 
        FROM `aml_dataset.transactions` t
        JOIN hop1 h ON t.sender_id = h.hop1_receiver
        WHERE t.timestamp > h.timestamp -- Money must move AFTER receiving it
      )
      SELECT 
        h1.sender_id as source,
        u1.name as source_name,
        h1.hop1_receiver as intermediate,
        u2.name as intermediate_name,
        h1.amount as amount_in,
        h2.hop2_receiver as final_destination,
        u3.name as destination_name,
        h2.amount as amount_out
      FROM hop1 h1
      LEFT JOIN hop2 h2 ON h1.hop1_receiver = h2.hop1_receiver
      JOIN `aml_dataset.users` u1 ON h1.sender_id = u1.user_id
      JOIN `aml_dataset.users` u2 ON h1.hop1_receiver = u2.user_id
      LEFT JOIN `aml_dataset.users` u3 ON h2.hop2_receiver = u3.user_id
      ORDER BY h1.timestamp DESC
      LIMIT 20

  # ----------------------------------------------------------------------
  # 3. NETWORK ANALYSIS - Counterparty Check
  # ----------------------------------------------------------------------
  analyze-counterparties:
    kind: bigquery-sql
    source: aml-analysis-data
    description: |
      Analyzes who a user transacts with most. 
      Flags if they are dealing with high-risk users.
    parameters:
      - name: user_id
        type: string
        description: The User ID to analyze.
    statement: |
      SELECT 
        CASE 
          WHEN t.sender_id = @user_id THEN t.receiver_id 
          ELSE t.sender_id 
        END as counterparty_id,
        u.name as counterparty_name,
        u.risk_score as counterparty_risk,
        COUNT(*) as txn_count,
        SUM(t.amount) as total_volume
      FROM 
        `aml_dataset.transactions` t
      JOIN 
        `aml_dataset.users` u ON (
          CASE 
            WHEN t.sender_id = @user_id THEN t.receiver_id 
            ELSE t.sender_id 
          END = u.user_id
        )
      WHERE 
        t.sender_id = @user_id OR t.receiver_id = @user_id
      GROUP BY 
        1, 2, 3
      ORDER BY 
        total_volume DESC
      LIMIT 10

  # ----------------------------------------------------------------------
  # 4. TRANSACTION HISTORY - Recent Activity
  # ----------------------------------------------------------------------
  get-recent-transactions:
    kind: bigquery-sql
    source: aml-analysis-data
    description: |
      Gets the last 20 transactions for a user.
    parameters:
      - name: user_id
        type: string
        description: The User ID.
    statement: |
      SELECT 
        txn_id,
        sender_id,
        receiver_id,
        amount,
        txn_type,
        timestamp
      FROM 
        `aml_dataset.transactions`
      WHERE 
        sender_id = @user_id OR receiver_id = @user_id
      ORDER BY 
        timestamp DESC
      LIMIT 20

  # ----------------------------------------------------------------------
  # 5. QUEUE - High Priority Alerts
  # ----------------------------------------------------------------------
  get-high-priority-alerts:
    kind: bigquery-sql
    source: aml-analysis-data
    description: |
      Gets the highest severity alerts that are still NEW.
    parameters: []
    statement: |
      SELECT 
        a.alert_id,
        a.trigger_reason,
        a.severity,
        u.name as user_name,
        u.risk_score,
        u.is_pep
      FROM 
        `aml_dataset.alerts` a
      JOIN 
        `aml_dataset.users` u ON a.user_id = u.user_id
      WHERE 
        a.status = 'NY'
      ORDER BY 
        CASE a.severity 
          WHEN 'HÃ–G' THEN 1 
          WHEN 'MEDEL' THEN 2 
          ELSE 3 
        END ASC,
        u.risk_score DESC
      LIMIT 10

toolsets:
  false-positive-reduction-toolset:
    - get-user-details
    - search-user-by-name
    - get-alert-details
    - trace-money-flow
    - analyze-counterparties
    - get-recent-transactions
    - get-high-priority-alerts